
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>admin - Expense Analysis</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
    font-family: Arial, sans-serif;
    background-color: #f9f9fc;
    margin: 0;
    padding: 20px;
    color: #333;
    background-image: url('https://thumbs.dreamstime.com/b/soft-pastel-smoky-gradient-background-featuring-smooth-transitions-colors-foggy-colorful-wallpaper-delicate-blend-323762478.jpg'); /* Image URL or relative path */
    background-size: cover;  
    background-repeat: no-repeat;  
    background-position: center;  
    margin: 0;
    padding: 20px;
    color: #333;
}


.container {
    display: flex;
    flex-direction: row;
    width: 100%;
    gap: 30px; /* Equal spacing between sections */
}

.left-section {
    flex: 0 0 20%; /* Fixed proportion for left section */
    max-width: 250px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.graph-container {
    flex: 2; /* Largest space for graph container */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    margin-top: -20px; /* Move the chart up by 20px */
}

.right-section {
    flex: 1; /* Proportional space for form */
    max-width: 300px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

.box {
    background: linear-gradient(135deg, #fc25d861, #6a11cb);
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    max-width: 100%;
}

/* Styling for the alert message after successful submission */
#alertMessage {
    font-size: 1.5em; /* Increased font size */
    text-align: center;
    font-weight: bold;
    margin-top: 10px;
    color: #FFFFFF; /* Green color */
    background-color: rgba(76, 175, 80, 0.1); /* Light green background */
    padding: 10px;
    border-radius: 5px;
}

h2 {
    font-size: 20px;
    margin-bottom: 10px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.radio-group {
    margin-bottom: 15px;
    color: #fff;
}

button {
    background-color: #2575fc;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
	
}

button:hover {
    background-color: #6a11cb;
}

canvas {
    width: 100%;
    height: 100%;
}

#totalAmountBox {
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-top: 10px; /* Adds space between this and the Expense Analysis box */
    margin-bottom: 10px; /* Ensures gap between other sections */
    margin-top: -5px; /* Moves the Total Amount box 5px up */
    gap: 10px;
}
#expenseForm {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    color: #fff;
    font-size: 1.2em;
}

#expenseForm input, 
#expenseForm textarea, 
#expenseForm button {
    width: 90%;
    padding: 12px;
    font-size: 1em;
    margin-bottom: 15px;
    border: none;
    border-radius: 5px;
    background-color: #f9f9f9;

    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#expenseForm button {
    background-color: #c151da91;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#expenseForm button:hover {
    background-color: #6a11cb;
}
.new-container {
    display: flex;
    flex-wrap: wrap; /* Prevents flex items from exceeding the row width */
    gap: 20px;
    max-width: 100%; /* Restricts the container's width */
    margin: 10px auto; /* Centers and adds space around the container */
    padding: 10px;
    overflow-x: hidden; /* Hides any overflow caused by child elements */
}

    .left-section, .right-section {
        flex: 1; /* Equal width for both sections */
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	 min-width: 0; /* Prevent overflow due to content */
    max-width: 50%; /* Restricts width when flex-grow is applied */

    }

   .left-section {
    flex: 1; /* Takes twice the space of .right-section */
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.right-section {
    flex: 2; /* Takes half the space of .left-section */
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	max-width: max-content;
}
.form-container {
    width: 90%; /* Increased width to make the form wider */
    max-width: 600px; /* Increased maximum width */
    margin:  auto; /* Centers the container */
    padding: 0px; /* Reduced padding to decrease overall height */
    background: linear-gradient(135deg, #2575fc, #6a11cb); /* Gradient background */
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Adds a shadow */
}

/* Inner box for form input fields */
.form-box {
    background-color: #fff; /* White background for input box */
    border-radius: 10px; /* Rounded corners */
    padding: 5px; /* Reduced padding for smaller height */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
	width: 100%;
	width:400px;
}

/* Title for the form */
h2 {
    font-size: 1.2em; /* Smaller font size for the heading */
    margin-bottom: 10px;
    color: #333; /* Neutral color for heading */
    text-align: center; /* Center align heading */
}

/* Event form styling */
#eventForm {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two columns */
    gap: 20px; /* Adds spacing between rows and columns */
    width: 90%; /* Full width of the container */
	margin-left: 10px;
}

#eventForm div {
    display: flex;
    flex-direction: column; /* Stack label and input vertically */
}

label {
    margin-bottom: 3px; /* Reduces space between label and input */
    color: #333; /* Dark text for readability */
    font-weight: bold; /* Makes the label more prominent */
    font-size: 0.8em; /* Smaller font size for labels */
}

#eventForm input, 
#eventForm textarea, 
#eventForm button {
    width: 100%; /* Input fields take up the full width of their grid cell */
    padding: 8px; /* Reduced padding for smaller height */
    font-size: 0.9em; /* Smaller font size for inputs */
    margin-bottom: 10px; /* Reduced spacing between fields */
    border: none;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
}

#eventForm input,
#eventForm textarea {
    background-color: #f9f9f9; /* Light gray background for inputs */
    color: #333; /* Dark text for readability */
}

#eventForm button {
    background-color: #c151da91; /* Primary button color */
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
    grid-column: span 2; /* Button spans the entire form width */
    font-size: 1em; /* Button font size remains consistent */
    padding: 10px; /* Adjusted padding for button size */
}

#eventForm button:hover {
    background-color: #6a11cb; /* Hover color for button */
}

/* Prevent textarea from resizing */
textarea {
    resize: none;
}


 .carousel-container {
            position: relative;
            overflow: hidden;
            width: 90%;
            margin: auto;
        }

        .event-carousel {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
        }

        

 .event-card {
        background: #f1da9238;
        border-radius: 8px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        margin: 10px;
        width: 200px;
        padding: 20px;
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative; /* Add relative positioning to allow absolute positioning of the delete button */
    }

        .event-card:hover {
            transform: scale(1.05);
        }

        .event-card h2 {
            color: #4CAF50;
            font-size: 20px;
            margin: 0 0 10px;
        }

        .event-card p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }

        .event-card .event-date {
            font-weight: bold;
        }

.delete-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #ff4c4c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease;
    }

    .delete-button:hover {
        background-color: #ff0000;
    }

    .delete-button:focus {
        outline: none;
}

        .nav-buttons {
            text-align: center;
            margin-top: 20px;
	    margin-left:100px;
        }

        .nav-button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 18px;
            margin:  10px;
        }

        .no-events {
            text-align: center;
            color: gray;
            font-size: 16px;
            margin-top: 50px;
        }
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color:#25242bed;
    padding: 10px 20px;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.navbar-heading {
    color: white;
    font-size: 1.5em;
    font-weight: bold;
	font-family: 'serif', Georgia;
}

.navbar-menu {
    list-style: none;
    display: flex;
    justify-content: flex-end; /* Align items to the right */
    margin: 0;
    padding: 0;
}

.navbar-menu li {
    margin-left: 20px; /* Spacing between items */
}

.navbar-menu a {
    color: white;
    text-decoration: none;
    font-size: 1.2em;
    font-weight: bold;
    padding: 8px 16px;
    transition: background-color 0.3s ease;
    border-radius: 5px;
font-family: 'Times New Roman', serif;
}

.navbar-menu a:hover {
    background-color: #6a11cb;
}

#expenseAnalysis, #eventAnalysis, #photoGallery {
    font-family: 'Times New Roman', serif;
}
.photo-container {
    margin-top: 30px; /* Add space above the container */
    padding-top: 5px;
padding-bottom: 5px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    margin: initial; /* Center the container */
}

.photo-container h2 {
    font-family: 'Roboto', sans-serif;
    color: #333;
    font-size: 1.5em;
    text-align: center;
    margin-bottom: 10px;
     margin-top: 1px
}

.form-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
background: linear-gradient(135deg, #fc25d861, #6a11cb);
}

.form-container label {
    font-weight: bold;
    font-size: 1em;
	margin-top: 10px;
}

.form-container input {
    padding: 10px;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.form-container button {
    background-color: #c151da91;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s ease;
}

.form-container button:hover {
    background-color: #6a11cb;
}

#photoAlert {
    font-size: 1em;
    text-align: center;
    margin-top: 10px;
}

/* Container for the form */
    </style>
</head>

<body>

<nav class="navbar">
<div class="navbar-heading">Sahayak: Admin Panel</div>
    <ul class="navbar-menu">
        <li><a href="#expenseAnalysis">Expense Analysis</a></li>
        <li><a href="#eventAnalysis">Event Analysis</a></li>
        <li><a href="#photoGallery">Photo Gallery</a></li>
    </ul>
</nav>

    <h1 id="expenseAnalysis"; >Expense Analysis</h1>
   <div class="container">
    <!-- Left Section -->
    <div class="left-section">
        <!-- Total Expenses Box -->
        <div class="box">
            <h2>Total Expenses</h2>
            <p id="totalAmount">Loading...</p>
        </div>

        <!-- Expense Analysis Box -->
        <div class="box">
            <h2>Expense Analysis</h2>
            <div class="radio-group">
                <label>Select Analysis Period:</label>
                <input type="radio" name="timePeriod" value="yearly"> Yearly<br>
                <input type="radio" name="timePeriod" value="monthly" checked> Monthly<br>
                <input type="radio" name="timePeriod" value="quarterly"> Quarterly
            </div>
            <div class="radio-group">
                <label>Select Graph Type:</label>
                <input type="radio" name="graphType" value="bar" checked> Bar<br>
                <input type="radio" name="graphType" value="pie"> Pie<br>
                <input type="radio" name="graphType" value="line"> Line
            </div>
            <button id="fetchDataButton"></button>
        </div>

        <!-- Total Amount Box -->
        <div class="box" style="margin-top: 10px;">
            <h2>Balance Amount</h2>
            <p id="totalAmountValue">Calculating...</p>
        </div>
    </div>

    <!-- Graph Section -->
    <div class="graph-container">
        <canvas id="expenseChart"></canvas>
	<div id="yearSelectionContainer" style="text-align: center; margin-top: 20px;"></div>

    </div>

    <!-- Right Section for Form -->
    <div class="right-section">
        <div class="box">
            <h2>Add New Expense</h2>
            <form id="expenseForm">
                <label for="amount">Amount:</label>
                <input type="number" id="amount" placeholder="Enter amount" required>

                <label for="date">Date:</label>
                <input type="date" id="date" required>

                <label for="description">Description:</label>
                <textarea id="description" rows="3" placeholder="Expense description" required></textarea>

                <button type="submit">Add Expense</button>
            </form>
            <p id="alertMessage" style="display: none; color: white;"></p>
        </div>
    </div>
</div>
<h1 id="eventAnalysis">Event Analysis</h1>
<div class="new-container">
    <!-- Left Section -->

    <div class="left-section">
        <!-- Place your content for the left section here -->
	

    <div id="expenseForm" style="flex: 1; background: linear-gradient(135deg, #fc25d861, #6a11cb); padding: 1px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); color: #fff; font-size: 1.2em; margin-left: 1px; width: 100%;"> <!-- Increased width -->
        <h2>Add New Event</h2>
        <div class="form-container">
    <div class="form-box">
        <h2>Event Management</h2>
        <form id="eventForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <label for="eventName">Event Name</label>
            <input type="text" id="eventName" name="eventName" required>
            
            <label for="eventDate">Event Date</label>
            <input type="date" id="eventDate" name="eventDate" required>
            
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3"></textarea>
            
            <label for="estimatedAmount">Estimated Amount</label>
            <input type="number" id="estimatedAmount" name="estimatedAmount" required>
            
            <label for="location">Location</label>
            <input type="text" id="location" name="location" required>
            
            <label for="map_link">Map Link</label>
            <input type="url" id="map_link" name="map_link">
            
            <button type="submit">Submit</button>
        </form>
    </div>
</div>

        <p id="eventAlertMessage" style="display: none; font-size: 1.5em; text-align: center; font-weight: bold; margin-top: 10px; color: #FFFFFF; background-color: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 5px;">
        </p>
    </div>
</div>

    

    <!-- Right Section -->
<div class="right-section">
    <h1>Upcoming Agenda</h1>
    <div class="carousel-container">
        <div id="agendaCarousel" class="event-carousel">
            <!-- Agenda cards will be dynamically injected here -->
        </div>
    </div>
    <div class="nav-buttons">
        <button class="nav-button left" onclick="scrollCarousel('agenda', 1)">&#8249;</button>
        <button class="nav-button right" onclick="scrollCarousel('agenda', -1)">&#8250;</button>
    </div>

    <h1>Events</h1>
    <div class="carousel-container">
        <div id="eventCarousel" class="event-carousel">
            <!-- Event cards will be dynamically injected here -->
        </div>
    </div>
    <div class="nav-buttons">
        <button class="nav-button left" onclick="scrollCarousel('events', 1)">&#8249;</button>
        <button class="nav-button right" onclick="scrollCarousel('events', -1)">&#8250;</button>
    </div>
</div>

</div>
              

<h1 id="photoGallery">Photo Gallery</h1>

<div class="photo-container">


    <h2> Add Photo</h2>
    <form id="photoForm" class="form-container">
        <label for="photoLink">Photo Link:</label>
        <input type="url" id="photoLink" placeholder="Enter photo URL" required>
        <button type="submit">Add Photo</button>
    </form>
    <p id="photoAlert" style="display: none; color: green;"></p>
</div>



    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBv3vKMih_ia_eADyo70cDHIrNTVBA-DM8",
            authDomain: "sahayak-sss1234.firebaseapp.com",
            projectId: "sahayak-sss1234",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const totalAmountElement = document.getElementById("totalAmount");
        const fetchDataButton = document.getElementById("fetchDataButton");
        const expenseChart = document.getElementById("expenseChart");

        // Fetch total expenses
        function getTotalAmount() {
            db.collection("expenses").get()
                .then(snapshot => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().amount;
                    });
                    totalAmountElement.textContent = '₹' + total.toFixed(2);
                })
                .catch(err => {
                    console.error(err);
                    totalAmountElement.textContent = "Failed to load data.";
                });
        }

        // Fetch and display chart
        fetchDataButton.addEventListener("click", () => {
            const timePeriod = document.querySelector('input[name="timePeriod"]:checked').value;
            const graphType = document.querySelector('input[name="graphType"]:checked').value;

            db.collection("expenses").get()
                .then(snapshot => {
                    const data = {};
                    snapshot.forEach(doc => {
                        const expense = doc.data();
                        const date = new Date(expense.date.seconds * 1000); // Assuming Firestore timestamp
                        const key = timePeriod === "monthly" ? `${date.getFullYear()}-${date.getMonth() + 1}` :
                                    timePeriod === "quarterly" ? `Q${Math.floor(date.getMonth() / 3) + 1}-${date.getFullYear()}` :
                                    date.getFullYear();
                        data[key] = (data[key] || 0) + expense.amount;
                    });

                    displayChart(Object.keys(data), Object.values(data), graphType);
                })
                .catch(err => console.error(err));
        });

        // Add expense form functionality
        const expenseForm = document.getElementById("expenseForm");
        const alertMessage = document.getElementById("alertMessage");

        expenseForm.addEventListener("submit", (e) => {
            e.preventDefault(); // Prevent page reload
            const amount = parseFloat(document.getElementById("amount").value);
            const date = document.getElementById("date").value;
            const description = document.getElementById("description").value;

            // Save data to Firestore
            db.collection("expenses").add({
                amount,
                date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                description
            })
                .then(() => {
                    alertMessage.textContent = "Expense added successfully!";
                    alertMessage.style.display = "block";
                    setTimeout(() => {
                        alertMessage.style.display = "none";
                    }, 3000);
                    expenseForm.reset();
                    getTotalAmount(); // Refresh total amount
                })
                .catch((error) => {
                    console.error("Error adding expense: ", error);
                    alertMessage.textContent = "Failed to add expense.";
                    alertMessage.style.color = "red";
                    alertMessage.style.display = "block";
                });
        });
	const totalAmountValue = document.getElementById("totalAmountValue");

function calculateTotalAmount() {
    let totalDonations = 0;

    let totalExpenses = 0;

    // Fetch total donations
    db.collection("donations").get()
        .then(snapshot => {
            snapshot.forEach(doc => {
                totalDonations += doc.data().amount;
            });

            // Fetch total expenses
            db.collection("expenses").get()
                .then(expenseSnapshot => {
                    expenseSnapshot.forEach(doc => {
                        totalExpenses += doc.data().amount;
                    });

                    // Calculate total amount
                    const totalAmount = totalDonations - totalExpenses;
                    totalAmountValue.textContent = '₹' + totalAmount.toFixed(2);
                })
                .catch(err => {
                    console.error("Error fetching expenses:", err);
                    totalAmountValue.textContent = "Failed to calculate.";
                });
        })
        .catch(err => {
            console.error("Error fetching donations:", err);
            totalAmountValue.textContent = "Failed to calculate.";
        });
}

// Call the function after fetching total expenses
calculateTotalAmount();

// Initialize chart with default settings on page load
window.onload = function() {
    // Set default radio button values
    document.querySelector('input[name="timePeriod"][value="yearly"]').checked = true;
    document.querySelector('input[name="graphType"][value="bar"]').checked = true;

    // Fetch and display chart with default values (yearly, bar)
    displayChartWithDefaults();
};

function displayChartWithDefaults() {
    const timePeriod = 'yearly'; // Default to yearly
    const graphType = 'bar'; // Default to bar chart

    db.collection("expenses").get()
        .then(snapshot => {
            const data = {};
            snapshot.forEach(doc => {
                const expense = doc.data();
                const date = new Date(expense.date.seconds * 1000); // Firestore timestamp
                const key = timePeriod === "monthly" ? `${date.getFullYear()}-${date.getMonth() + 1}` :
                            timePeriod === "quarterly" ? `Q${Math.floor(date.getMonth() / 3) + 1}-${date.getFullYear()}` :
                            date.getFullYear();
                data[key] = (data[key] || 0) + expense.amount;
            });

            // Call the function to display the chart
            displayChart(Object.keys(data), Object.values(data), graphType);
        })
        .catch(err => console.error(err));
}

// Function to display chart based on selected values
function displayChart(labels, data, graphType) {
    const ctx = expenseChart.getContext("2d");

    if (window.chart) {
        window.chart.destroy(); // Destroy the previous chart if any
    }

    window.chart = new Chart(ctx, {
        type: graphType, // Bar chart, Pie chart, or Line chart
        data: {
            labels: labels,
            datasets: [{
                label: 'Expenses',
                data: data,
                backgroundColor: graphType === "bar" ? 'rgba(75, 192, 192, 0.2)' : 'rgba(153, 102, 255, 0.2)',
                borderColor: graphType === "bar" ? 'rgba(75, 192, 192, 1)' : 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: graphType === 'bar' ? {
                y: {
                    beginAtZero: true
                }
            } : {}
        }
    });
}

// Helper function to format dates based on time period
function formatDateByTimePeriod(date, timePeriod) {
    return timePeriod === "monthly"
        ? `${date.getFullYear()}-${date.getMonth() + 1}`
        : timePeriod === "quarterly"
        ? `Q${Math.floor(date.getMonth() / 3) + 1}-${date.getFullYear()}`
        : date.getFullYear();
}

// Fetch data from Firestore and update chart
function updateChart() {
    const timePeriod = document.querySelector('input[name="timePeriod"]:checked').value;
    const graphType = document.querySelector('input[name="graphType"]:checked').value;

    console.log(`Updating chart for timePeriod: ${timePeriod}, graphType: ${graphType}`);

    Promise.all([
        db.collection("expenses").get(),
        db.collection("donations").get(),
    ])
        .then(([expenseSnapshot, donationSnapshot]) => {
            const expensesData = {};
            const donationsData = {};

            // Process expenses
            expenseSnapshot.forEach((doc) => {
                const expense = doc.data();
                if (expense.date && expense.amount) {
                    const date = new Date(expense.date.seconds * 1000);
                    const key = formatDateByTimePeriod(date, timePeriod);
                    expensesData[key] = (expensesData[key] || 0) + expense.amount;
                }
            });

            // Process donations
            donationSnapshot.forEach((doc) => {
                const donation = doc.data();
                if (donation.date && donation.amount) {
                    const date = new Date(donation.date.seconds * 1000);
                    const key = formatDateByTimePeriod(date, timePeriod);
                    donationsData[key] = (donationsData[key] || 0) + donation.amount;
                }
            });

            // Combine data
            const labels = Array.from(
                new Set([...Object.keys(expensesData), ...Object.keys(donationsData)])
            ).sort();
            const expensesValues = labels.map((label) => expensesData[label] || 0);
            const donationsValues = labels.map((label) => donationsData[label] || 0);

            console.log({ labels, expensesValues, donationsValues });

            // Call displayChart function
            displayChart(labels, expensesValues, donationsValues, graphType);
        })
        .catch((error) => console.error("Error updating chart:", error));
}

// Function to render the chart
function displayChart(labels, expensesData, donationsData, graphType) {
    const ctx = document.getElementById("expenseChart").getContext("2d");

    if (window.chart) {
        window.chart.destroy(); // Destroy any existing chart
    }

    window.chart = new Chart(ctx, {
        type: graphType,
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Expenses",
                    data: expensesData,
                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                    borderColor: "rgba(255, 99, 132, 1)",
                    borderWidth: 1,
                },
                {
                    label: "Donations",
                    data: donationsData,
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                },
            ],
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                },
            },
        },
    });
}

// Initialize event listeners for radio buttons
window.onload = function () {
    updateChart(); // Initialize the chart on page load

    // Attach listeners to time period and graph type radio buttons
    document.querySelectorAll('input[name="timePeriod"]').forEach((input) => {
        input.addEventListener("change", updateChart);
    });
    document.querySelectorAll('input[name="graphType"]').forEach((input) => {
        input.addEventListener("change", updateChart);
    });
};





        // Initialize
        getTotalAmount();


   const eventForm = document.getElementById("eventForm");
const eventAlertMessage = document.getElementById("eventAlertMessage");

eventForm.addEventListener("submit", (e) => {
    e.preventDefault(); // Prevent page reload

    const eventName = document.getElementById("eventName").value;
    const eventDate = document.getElementById("eventDate").value;
    const location = document.getElementById("location").value;
    const description = document.getElementById("description").value;
    const estimatedAmount = parseFloat(document.getElementById("estimatedAmount").value);
    const map_link = document.getElementById("map_link").value;

    // Create the event data object
    const eventData = {
        eventName,
        eventDate: firebase.firestore.Timestamp.fromDate(new Date(eventDate)),
        location,
        description,
        estimatedAmount,
        map_link
    };

        // Save data to Firestore
         db.collection("event_id").add(eventData)
        .then(() => {
            // After saving to "event_id", save the same data to "agenda" collection
            return db.collection("agenda").add(eventData);
        })
        .then(() => {
            // If both saves are successful
            eventAlertMessage.textContent = "Event added successfully to collections!";
            eventAlertMessage.style.display = "block";
            eventAlertMessage.style.color = "white";
		eventAlertMessage.style.fontSize = "20px";
            setTimeout(() => {
                eventAlertMessage.style.display = "none";
            }, 3000);
            eventForm.reset();
        })
        .catch((error) => {
            console.error("Error adding event: ", error);
            eventAlertMessage.textContent = "Failed to add event.";
            eventAlertMessage.style.color = "red";
            eventAlertMessage.style.display = "block";
        });
});
      
 // Function to handle Firestore date fields
        function formatDate(date) {
            if (!date) return "Date not available";
            try {
                if (date.toDate) {
                    // Firestore Timestamp
                    return date.toDate().toDateString();
                } else if (typeof date === "string" || typeof date === "number") {
                    // String or numeric date
                    return new Date(date).toDateString();
                }
            } catch (error) {
                console.error("Error formatting date:", error);
            }
            return "Invalid Date";
        }

 // Scroll Carousel function
        function scrollCarousel(type, direction) {
            const carousel = type === 'agenda' ? document.getElementById("agendaCarousel") : document.getElementById("eventCarousel");
            const cardWidth = document.querySelector('.event-card').offsetWidth + 20;  // width of a card + margin
            const carouselWidth = carousel.scrollWidth;  // total width of all cards
            const containerWidth = document.querySelector('.carousel-container').offsetWidth;  // visible area width
            const currentTransform = getComputedStyle(carousel).transform;
            let currentPos = currentTransform === 'none' ? 0 : parseInt(currentTransform.split(',')[4].trim());
            let newPos = currentPos + (direction * cardWidth);

            // Prevent scrolling past the first card (left) and the last card (right)
            if (newPos > 0) {
                newPos = 0;  // Stop at the first card
            } else if (Math.abs(newPos) >= carouselWidth - containerWidth) {
                newPos = -(carouselWidth - containerWidth);  // Stop at the last card
            }

            carousel.style.transform = `translateX(${newPos}px)`;
        }

        // Fetch Agenda and Sort by Date (latest first) using Firestore's `orderBy`
       

    // Fetch Agenda and Sort by Date (latest first) using Firestore's `orderBy`
    const agendaCarousel = document.getElementById("agendaCarousel");
    db.collection("agenda")
        .orderBy("eventDate", "desc") // Sort by eventDate in descending order
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                agendaCarousel.innerHTML = `<p class="no-events">No agenda items are currently scheduled.</p>`;
                return;
            }

            snapshot.forEach(doc => {
                const agenda = doc.data();
                const eventDate = formatDate(agenda.eventDate);

                // Create the agenda card
                const agendaCard = `
                    <div class="event-card" id="card-${doc.id}">
                        <h2>${agenda.eventName}</h2>
                        <p>${agenda.description}</p>
                        <p class="event-date">Date: ${eventDate}</p>
                        <button class="delete-button" onclick="deleteAgenda('${doc.id}')">D</button>
                    </div>
                `;

                // Add the card to the agenda carousel
                agendaCarousel.innerHTML += agendaCard;
            });
        })
        .catch(error => {
            console.error("Error fetching agenda: ", error);
            agendaCarousel.innerHTML = `<p class="no-events" style="color: red;">Failed to load agenda. Please try again later.</p>`;
        });

    // Function to delete an agenda item from Firestore
    function deleteAgenda(docId) {
        const agendaCard = document.getElementById(`card-${docId}`);

        // Remove the card from the DOM
        agendaCard.remove();

        // Delete the document from Firestore
        db.collection("agenda").doc(docId).delete()
            .then(() => {
                console.log(`Agenda item with ID: ${docId} deleted successfully.`);
            })
            .catch((error) => {
                console.error("Error deleting agenda item: ", error);
            });
    }




        // Fetch Events and Sort by Date (latest first) using Firestore's `orderBy`
        const eventCarousel = document.getElementById("eventCarousel");
        db.collection("event_id")
            .orderBy("eventDate", "desc") // Sort by eventDate in descending order
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    eventCarousel.innerHTML = `<p class="no-events">No events in the database.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const event = doc.data();
                    const eventDate = formatDate(event.eventDate);

                    const eventCard = `
                        <div class="event-card">
                            <h2>${event.eventName}</h2>
                            <p>${event.description}</p>
                            <p class="event-date">Date: ${eventDate}</p>
                        </div>
                    `;

                    eventCarousel.innerHTML += eventCard;
                });
            })
            .catch(error => {
                console.error("Error fetching events: ", error);
                eventCarousel.innerHTML = `<p class="no-events" style="color: red;">Failed to load events. Please try again later.</p>`;
            });
const agendaContainer = document.getElementById("agenda-container");

   function calculateTotalAmount() {
    let totalDonations = 0;
    let totalExpenses = 0;

    // Fetch total donations
    db.collection("donations").get()
        .then(snapshot => {
            snapshot.forEach(doc => {
                totalDonations += doc.data().amount;
            });

            // Fetch total expenses
            db.collection("expenses").get()
                .then(expenseSnapshot => {
                    expenseSnapshot.forEach(doc => {
                        totalExpenses += doc.data().amount;
                    });

                    // Calculate total amount
                    const totalAmount = totalDonations - totalExpenses;
                    totalAmountValue.textContent = '₹' + totalAmount.toFixed(2);

                    // Check if funds are about to finish
                    if (totalAmount <= 1000) {
                        displayFundsAlert();
                    }
                })
                .catch(err => {
                    console.error("Error fetching expenses:", err);
                    totalAmountValue.textContent = "Failed to calculate.";
                });
        })
        .catch(err => {
            console.error("Error fetching donations:", err);
            totalAmountValue.textContent = "Failed to calculate.";
        });
}

// Function to display funds alert in the graph container
function displayFundsAlert() {
    const graphContainer = document.querySelector('.graph-container'); // Get the graph container
    const alertMessage = document.createElement("div");
    alertMessage.textContent = "Funds about to finish!";
    alertMessage.style.backgroundColor = "#ffcc00";
    alertMessage.style.color = "#333";
    alertMessage.style.padding = "10px";
    alertMessage.style.textAlign = "center";
    alertMessage.style.borderRadius = "5px";
    alertMessage.style.fontWeight = "bold";
    alertMessage.style.position = "absolute"; // Position it over the chart
    alertMessage.style.top = "20px";
    alertMessage.style.left = "50%";
    alertMessage.style.transform = "translateX(-50%)";
    alertMessage.style.zIndex = "1000";
    alertMessage.style.width = "auto"; // Set width to auto for better control

    // Append the alert message inside the graph container
    graphContainer.appendChild(alertMessage);

    // Remove alert after 5 seconds
    setTimeout(() => {
        alertMessage.remove();
    }, 5000);
}

// Call the function after fetching total expenses
calculateTotalAmount();
const photoForm = document.getElementById("photoForm");
const photoAlert = document.getElementById("photoAlert");

// Firestore reference to the photogallery collection
const photoGalleryRef = db.collection("photogallery");

// Form submission event
photoForm.addEventListener("submit", (e) => {
    e.preventDefault(); // Prevent page reload on form submission

    const photoLink = document.getElementById("photoLink").value;

    if (!photoLink) {
        photoAlert.textContent = "Photo link cannot be empty!";
        photoAlert.style.color = "red";
        photoAlert.style.display = "block";
        setTimeout(() => (photoAlert.style.display = "none"), 3000);
        return;
    }

    // Add photo link to Firestore
    photoGalleryRef
        .add({ photo: photoLink })
        .then(() => {
            photoAlert.textContent = "Photo added successfully!";
            photoAlert.style.color = "green";
            photoAlert.style.display = "block";
            photoForm.reset(); // Clear form inputs
            setTimeout(() => (photoAlert.style.display = "none"), 3000);
        })
        .catch((error) => {
            console.error("Error adding photo to Firestore:", error);
            photoAlert.textContent = "Failed to add photo. Try again.";
            photoAlert.style.color = "red";
            photoAlert.style.display = "block";
        });
});


   
           </script>
</body>

</html>
